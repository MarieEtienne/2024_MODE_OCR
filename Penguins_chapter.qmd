---
title: "Exploring data on penguins" 
author: "CHOULETTE Klervi, DENIS Manon, DUPORT Maureen, MOTTE Arthur, POYARD Antoine, SESIA Marion, TANGUY Céline" 
bibliography: references.bib 
execute:
  freeze: auto
  warning: false
output: 
  html_document: 
    toc: true 
    toc_float: true 
    toc_depth: 3
---

# Introduction {style="color:navy"}

## Study context {style="color:royalblue"}

This document is a report on the analysis of a dataset on penguins. This dataset contains information on various [variables](#column_name). The dataset was find on Kaggle : https://www.kaggle.com/datasets/utkarshx27/penguin-size-clutch-and-blood-isotope-data?select=penguins_raw.csv

This document is a report on the analysis of a dataset on penguins. The data collected contains informations on multiples [variables](#colum-name). This dataset was made from differents articles according by Gorman *et al.* [@10.1371/journal.pone.0090081] and Horst *et al.* [@10.32614/RJ-2022-020]. It focused on three penguin species : Adelie (*Pygoscelis adeliae*), Chinstrap (*Pygoscelis antarcticus*) and Gentoo (*Pygoscelis papua*). The dataset contains 344 observations and 17 variables. The goal of this analysis is to explore the dataset and to identify the main characteristics of the penguins.

```{r, results='hide'}
#| message: false
#| warning: false
#| echo: true
#| results: hide
#| code-fold: true
#| code-summary: "Show the code"

library(factoextra)         # for data visualization
library(FactoMineR)         # for PCA
library(tidyverse)          # for data manipulation and visualization
library(dplyr)              # for data manipulation
library(ggplot2)            # for data visualization
library(corrplot)           # for correlation test
library(sf)                 # for spatial data
library(rnaturalearth)      # for earth maps
library(rnaturalearthdata)  # for earth dataset
library(ggspatial)          # for spatial plot
library(gridExtra)          # for arranging plot
library(kableExtra)         # for enhanced tables
```

## Location {style="color:royalblue"}

Data were collected in Antarctica on Biscoe, Dream and Torgersen Islands. These three blue points show the location of the data collect in @fig-map_antarctica.

```{r}
#| label: fig-map_antarctica
#| fig-cap: "Maps of Antarctica with the collect points"
#| code-fold: true
#| code-summary: "Show the code"
#| warning: false
# Download country data (including Antarctica)
world <- ne_countries(scale = "medium", returnclass = "sf")

# Filter to keep only Antarctica
antarctica <- world[world$continent == "Antarctica", ]

rectangle_coords <- st_as_sfc(st_bbox(c(xmin = -90, xmax = -55, ymin = -75, ymax = -60), crs = st_crs(4326)))

antarctic_proj <- "+proj=laea +lat_0=-90 +datum=WGS84"
# Transform the rectangle into the polar projection system
rectangle_proj <- st_transform(rectangle_coords, crs = antarctic_proj)

# Create the map
gg_antartique = ggplot(data = antarctica) +
    annotate("rect", xmin = -90, xmax = -55, ymin = -75, ymax = -60,
           fill = "blue") +
  geom_sf() +
  coord_sf(crs = "+proj=laea +lat_0=-90 +datum=WGS84") +
 annotate("rect", 
           xmin = st_bbox(rectangle_proj)["xmin"], xmax = st_bbox(rectangle_proj)["xmax"], 
           ymin = st_bbox(rectangle_proj)["ymin"], ymax = st_bbox(rectangle_proj)["ymax"], 
           alpha = 0.2, fill = "blue")+
  theme_minimal() +
  labs(title = "Antarctica map",
       caption = "Data: Natural Earth") +
  annotation_scale(location = "bl", width_hint = 0.5)

antarctic_proj <- "+proj=laea +lat_0=-90 +datum=WGS84"

# Point coordinates in longitude and latitude
point_coords <- data.frame(lon = c(-66.209547, -64, -65), lat = c(-66, -65, -64.8))

# Convert the point into an sf object (longitude/latitude coordinate system WGS84)
point_sf <- st_as_sf(point_coords, coords = c("lon", "lat"), crs = 4326)

# Transform the point into the projected coordinate system of the map
point_proj <- st_transform(point_sf, crs = antarctic_proj)

# Extract the projected coordinates for use in annotate
point_proj_coords <- st_coordinates(point_proj)

# Create a bounding box manually with the coordinates
# Convert the bounding box into an sf object
bbox_sf <- st_as_sfc(st_bbox(c(xmin = -90, xmax = -55, ymin = -75, ymax = -60)))

# Crop the map using the bounding box
antarctica_cropped <- st_crop(antarctica, bbox_sf)

# Create the map
gg_zone_interet = ggplot() +
  geom_sf(data = antarctica_cropped) +
  geom_sf(data = point_proj, color = "blue", size = 3, alpha = 0.8, shape = 19) +

  coord_sf(crs = "+proj=laea +lat_0=-90 +datum=WGS84") +
  theme_minimal() +
  labs(title = "Area of Interest",
       caption = "Data: Natural Earth") +
  annotation_scale(location = "bl", width_hint = 0.5)

grid.arrange(gg_antartique, gg_zone_interet, ncol = 2)

```

## Dataset presentation {#column_name}

**Columns name :**

-   *studyName* : sampling expedition from which data were collected, generated, etc.\
-   *Sample Number* : an integer denoting the continuous numbering sequence for each sample\
-   *Species* : a character string denoting the penguin species\
-   *Region* : a character string denoting the region of Palmer LTER sampling grid\
-   *Island* : a character string denoting the island near Palmer Station where samples were collected\
-   *Stage* : a character string denoting the reproductive stage at the time of sampling\
-   *Individual ID* : a character string denoting the unique ID for each individual in dataset\
-   *Clutch Completion* : a character string denoting if the study nest was observed with a full clutch, i.e., 2 eggs\
-   *Date Egg* : a date denoting the date study nest observed with 1 egg (sampled)\
-   *Culmen Length* : a number denoting the length of the dorsal ridge of a bird's bill (millimeters)\
-   *Culmen Depth* : a number denoting the depth of the dorsal ridge of a bird's bill (millimeters)\
-   *Flipper Length* : an integer denoting the length penguin flipper (millimeters)\
-   *Body Mass* : an integer denoting the penguin body mass (grams)\
-   *Sex* : a character string denoting the sex of an animal\
-   *Delta 15 N* : a number denoting the measure of the ratio of stable isotopes 15N:14N\
-   *Delta 13 C* : a number denoting the measure of the ratio of stable isotopes 13C:12C\
-   *Comments* : a character string with text providing additional relevant information for data

Loading dataset :

```{r}
data <- read.table("penguins_raw.csv", sep = "," , header = TRUE, stringsAsFactors = T)
summary(data)
# dim(data)
```

Names modification of columns and species :

```{r}
#| code-fold: true
#| code-summary: "Show the code"
data <- data %>%
  select(-X) %>%                   # Remove X column 
  select(-Comments) %>%           # Remove Comments column
  rename(                          # we rename the columns of the dataset
    sample_number = Sample.Number,
    id = Individual.ID,
    island = Island,
    region = Region,
    stage = Stage,
    clutch_completion = Clutch.Completion,
    date_egg = Date.Egg,
    culmen_length = Culmen.Length..mm.,
    culmen_depth = Culmen.Depth..mm.,
    flipper_length = Flipper.Length..mm.,
    body_mass = Body.Mass..g.,
    sex = Sex,
    delta_15_N = Delta.15.N..o.oo.,
    delta_13_C = Delta.13.C..o.oo.,
    species = Species)

names(data)

# rename species
data = data %>%
  mutate(species = recode(species, "Adelie Penguin (Pygoscelis adeliae)" = "Adelie", "Chinstrap penguin (Pygoscelis antarctica)" = "Chinstrap", "Gentoo penguin (Pygoscelis papua)" = "Gentoo"))

```

These names are easier to understand.

## Missing values {style="color:royalblue"}

The @fig-missing-val have a red line that represents the mean of missing values (NA) in the dataset and the bars are showing the number of NA's for each variables.

```{r}
#| label: fig-missing-val
#| fig-cap: "Number of missing value as a function of each variables"
#| code-fold: true
#| code-summary: "Show the code"

# Verification of missing values
colSums(is.na(data)) 

data_NA <- data 

# Representation of missing values
NA_df <- (colSums(is.na(data_NA)) / nrow(data_NA)) * 100

color_pal <- colorRampPalette(c("limegreen", "yellow", "firebrick"), bias = 20)(10)
NA_col <- color_pal[as.integer(NA_df/length(NA_df)*9)+1]

# Graphique
barplot(NA_df,ylab = "NA", col = NA_col, las=2, cex.names=0.6)

NA_mean<-mean(NA_df)
# 0.78% 

abline(h=NA_mean, col = "red", lwd = 2)


```

# Exploratory analysis {style="color:navy"}

In this dataset, we would like to compare the different qualitative variables :\
- *Culmen Length*\
- *Culmen Depth*\
- *Flipper Length*\
- *Body Mass*\
- *Delta 13C*\
- *Delta 15N*\

## Correlation {style="color:royalblue"}

To compare these qualitative variables, we begin by examining the correlations among them.

The representation of this matrix is not optimal.

```{r}
sub_data_num = data%>%
  select(culmen_length, culmen_depth,flipper_length,body_mass,delta_13_C,delta_15_N)%>%
  na.omit() # we delete the few individuals with NA

matcor = cor(sub_data_num,method = "pearson")
matcor
```

We can use the library *corrplot* to make some visual correlation matrix.

There is a correlation that we have to remove in a multivariate analysis between the *body_mass* variable and the *flipper_length* as we can see in @fig-cor_mat2 and @fig-cor_mat3.

```{r}
#| label: fig-cor_mat2
#| fig-cap: "Correlation matrix with numbers"
#| code-fold: true
#| code-summary: "Show the code"

corrplot(matcor, method = "number", type = "upper",order = "hclust", tl.col="black", tl.srt=45)
```

```{r}
#| label: fig-cor_mat3
#| fig-cap: "Correlation matrix with forms"
#| code-fold: true
#| code-summary: "Show the code"
corrplot(matcor, type = "upper",order = "hclust", tl.col="black", tl.srt=45)
```

Now, we want to observe whether certain qualitative variables have an effect on body mass. We will therefore try to create a graph for each factor (qualitative variables) according to body mass:\
- *Species*\
- *Island*\
- *Sex*\

We have noticed some trends in @fig-boxplot_trends that we will have to confirm with statistical tests.\
[Box1]{.underline}: Gentoo penguins appear to be heavier than the other two species.\
[Box2]{.underline}: Penguins from Biscoe Island appear to be heavier than the other two islands.\
[Box3]{.underline}: Male penguins appear to be heavier than the other two categories.

```{r}
#| label: fig-boxplot_trends
#| fig-cap: "Boxplots between body mass and other variables"
#| code-fold: true
#| code-summary: "Show the code"

box1 <- ggplot(data = data)+
  geom_boxplot(aes(x=species,y=body_mass, fill = species))

box2 <- ggplot(data = data)+
  geom_boxplot(aes(x=island,y=body_mass, fill = island))

box3 <- ggplot(data = data)+
  geom_boxplot(aes(x=sex,y=body_mass, fill = sex))
global_box <- grid.arrange(box1,box2,box3)
```

## Violin plot {style="color:royalblue"}

Here is another way to visualize in @fig-violin the distribution between two variables.

```{r violin, fig.height=3, fig.width=9}
#| label: fig-violin
#| fig-cap: Violin plot of body mass as function of many variables
#| code-fold: true
#| code-summary: "Show the code"


# Violin plot for Culmen Length (beak length)
v1 <- ggplot(data, aes(x = species, y = culmen_length, fill = species)) +
  geom_violin(trim = FALSE) +
  geom_jitter(shape = 16, position = position_jitter(0.2), color = "black", alpha = 0.3) +
    stat_summary(fun = mean, geom = "point", shape = 20, size = 3, fill = "red", color = "red") +
  labs(title = "Distribution of Culmen Length by Species",
       x = "Species",
       y = "Culmen Length (mm)") +
  theme_minimal() +
  theme(legend.position = "none",
        plot.title = element_text(size = 10, face = "bold"),
        axis.title.x = element_text(size = 8),  # Taille de l'axe x
        axis.title.y = element_text(size = 8))

# Violin plot for Flipper Length
v2 <- ggplot(data, aes(x = species, y = flipper_length, fill = species)) +
  geom_violin(trim = FALSE) +
  geom_jitter(shape = 16, position = position_jitter(0.2), color = "black", alpha = 0.3) +
    stat_summary(fun = mean, geom = "point", shape = 20, size = 3, fill = "red", color = "red") +
  labs(title = "Distribution of Flipper Length by Species",
       x = "Species",
       y = "Flipper Length (mm)") +
  theme_minimal() +
  theme(legend.position = "none",
        plot.title = element_text(size = 10, face = "bold"),
        axis.title.x = element_text(size = 8),  # Taille de l'axe x
        axis.title.y = element_text(size = 8))

# Violin plot for Body Mass
v3 <- ggplot(data, aes(x = species, y = body_mass, fill = species)) +
  geom_violin(trim = FALSE) +
  geom_jitter(shape = 16, position = position_jitter(0.2), color = "black", alpha = 0.3) +
    stat_summary(fun = mean, geom = "point", shape = 20, size = 3, fill = "red", color = "red") +
  labs(title = "Distribution of Body Mass by Species",
       x = "Species",
       y = "Body Mass (g)") +
  theme_minimal() +
  theme(legend.position = "none",
        plot.title = element_text(size = 10, face = "bold"),
        axis.title.x = element_text(size = 8),  # Taille de l'axe x
        axis.title.y = element_text(size = 8))

grid.arrange(v1, v2, v3,  #names of graphs  
             ncol = 3, nrow = 1)
```
'
## ANOVAs, U-Mann-Whitney tests, Student test {style="color:royalblue"}

We run ANOVAs to verify these differences.\
There is a significant **difference between the body mass of these 3 species**, almost 2 of them, with a p-value of *2e-16*.

```{r}
# homoscedasticity
bartlett.test(data$body_mass~data$species) # p = 0.05005 > 0.05 homoscedasticity conditions are satisfied

anova1 = aov(data$body_mass~data$species)

#normality of residuals
shapiro.test(residuals(anova1)) #p = 0.05118 > 0.05, the normality of residuals is accepted

summary(anova1)
```

We perform a Tukey's post-hoc test to see where the differences lie. There is a significant difference between the body mass of *Gentoo* and *Adelie* (p = 0) and *Gentoo* and *Chinstrap* (p = 0). There is no significant difference between *Adelie* and *Chinstrap*.

```{r}
TukeyHSD(anova1)
```

We cannot perform an ANOVA between body mass and islands because the homoscedasticity conditions are not satisfied, so we will perform a Kruskall-Wallis test. There is a significant **difference between the body mass of these 3 islands**, almost 2 of them, with a p-value of *2e-16*.

```{r}
# homoscedasticity
bartlett.test(data$body_mass~data$island) # p = 8.978e-14 < 0.05 homoscedasticity conditions are not satisfied

# Kruskall Wallis test
kruskal.test(data$body_mass~data$island)

```

In order to observe the differences between the islands, we are going to carry out tests to compare the average between each island.

```{r}
# normality
tapply(data$body_mass, data$island, shapiro.test)
# Biscoe: p = 0.00209 < 0.05, normality is not respected
# Dream: p = 0.4161 > 0.05, normality is respected
# Torgersen: p =  0.2636 > 0.05, normality is respected
```

Data normality is respected for Torgensen Island and Dream Island. We will therefore carry out a homoscedasticity test between these islands to determine the appropriate mean comparison test.

```{r}
# Filter the data between the islands
dream_data <- subset(data, island == "Dream")$body_mass
torgersen_data <- subset(data, island == "Torgersen")$body_mass
biscoe_data <- subset(data, island == "Biscoe")$body_mass

# Perform a variance test between the 'Dream' and 'Torgersen' groups
var.test(dream_data, torgersen_data) # p = 0.5526 > 0.05, homoscedasticity conditions are satisfied

```

We will therefore carry out two U-Mann-Whitney tests between the Biscoe and Torgersen Islands and the Biscoe and Dream Islands, and a Student t-test between the Dream and Torgersen Islands.

```{r}
# U-Mann Withney test between the Biscoe and Torgersen
wilcox.test(biscoe_data, torgersen_data) # p = 1.396e-14 < 0.05

# U-Mann Withney test between the Biscoe and Dream
wilcox.test(biscoe_data, dream_data) # p = 2.2e-16 < 0.05

# Student t-test between the Dream and Torgersen
t.test(dream_data, torgersen_data, var.equal = T) # p = 0.9265 > 0.05
```

There is a significant difference in body mass between Dream and Biscoe Islands (p = 2.2e-16) and between Torgersen and Biscoe Islands (p = 1.396e-14). There was no significant difference between Torgersen and Dream Islands.

As there are only two modalities for gender, instead of an ANOVA we will perform a U-Mann-Whitney mean comparison test. There is a significant **difference between the body mass and the sex** with a p-value of *1.813e-15*.

```{r}
# normality
tapply(data$body_mass, data$sex, shapiro.test)
# Female: p = 6.155e-08 < 0.05, normality is not respected
# Male: p = 1.227e-07 < 0.05, normality is not respected

# U-Mann Withney test
female_data = subset(data, sex == "FEMALE")$body_mass
male_data = subset(data, sex == "MALE")$body_mass
wilcox.test(female_data, male_data) # p = 1.813e-15 < 0.05
```

Distribution of species between the islands in @tbl-table-distribution : we can see from this table that the *Adelie* species is present on all three islands, while the *Chrinstrap* and *Gentoo* species are only present on 2 islands, Dream and Biscoe respectively.

```{r}
#| label: tbl-table-distribution
#| tbl-cap: Species distribution between the islands
#| code-fold: true
#| code-summary: "Show the code"

species_islands <- table(data$island, data$species)
kable(species_islands, "html", escape = F) %>%
  kable_styling(bootstrap_options = c("striped"),
                full_width = F,
                position = "center")
```

## Graphical representations and interpretations {style="color:royalblue"}

In @fig-bdm-lenght, it would appear that there is a positive linear trend between the *body_mass* variable and *flipper_length* for each species.

```{r}
#| label: fig-bdm-lenght
#| fig-cap: Flipper length as a function of body mass 
#| code-fold: true
#| code-summary: "Show the code"

ggplot(data, aes(x = flipper_length, y = body_mass, color = species))+
  geom_point()+
  scale_color_manual(values = c("#B2DF8A","#FDBF6F","#CAB2D6"))+
  geom_smooth(method = "lm", col = "red", se = TRUE)+
  theme_bw()+
  theme(legend.position = "none")+
  facet_grid(~species)
```

Check with linear regression :

```{r}

rl1 <- lm(body_mass ~ flipper_length + species + species:flipper_length, data = data)
summary(rl1)

```

These results show a highly significant effect of fin length for all species, with a greater effect for the *Gentoo* species. There was also a significant difference in body mass between species except between *Adelie* and *Chinstrap*.

In conclusion, we can say that fin length influences body mass and that this effect varies according to species.

It would appear that there is a positive linear trend between the *body_mass* variable and *flipper_length* for each species.

In the @fig-lenght-depth, it would appear that there is a positive linear trend between the *culmen_depth* variable and *culmen_length* for each species.

```{r}
#| label: fig-lenght-depth
#| fig-cap: Culmen length as a function of culmen depth 
#| code-fold: true
#| code-summary: "Show the code"

ggplot(data, aes(x = culmen_length, y = culmen_depth, color = species))+
  geom_point()+
  scale_color_manual(values = c("#B2DF8A","#FDBF6F","#CAB2D6"))+
  geom_smooth(method = "lm", col = "red", se = TRUE)+
  theme_bw()+
  theme(legend.position = "none")+
  facet_grid(~species)
```

Check with linear regression :

```{r}
rl2 <- lm(culmen_depth ~ culmen_length + species + species:culmen_length, data = data)
summary(rl2)
```

These results show that beak length is significant and positive in *Adelie*. In the species *Chinstrap* and *Gentoo*, the beak depth is smaller and is significant in *Gentoo*. At the interaction level, it is not significant, which means that the effect of beak length on depth is relatively the same for 3 species.

We can conclude that beak depth depends on beak length but this does not vary between species. *Gentoo* penguins have a shallower beak than the others.

In @fig-delta, it seems to be different trends between species.

```{r, fig.width=10, fig.height=5}
#| label: fig-delta
#| fig-cap: Delta_15_N as a function of delta_13_C 
#| code-fold: true
#| code-summary: "Show the code"

ggplot(data, aes(x = delta_15_N, y = delta_13_C, color = species))+
  geom_point()+
  scale_color_manual(values = c("#B2DF8A","#FDBF6F","#CAB2D6"))+
  geom_smooth(method = "lm", col = "red", se = TRUE)+
  theme_bw()+
  theme(legend.position = "none")+
  facet_grid(~species)
```

We check this using a linear model :

```{r}
rl3 <- lm(delta_13_C ~ delta_15_N + species + species:delta_15_N, data = data)
summary(rl3)
```

These results show that the relationship between nitrogen 15 and carbon 13 is positive and significant in *Adelie*, this relationship is reduced in *Chinstrap* and even more so in *Gentoo*. *Chinstrap* and *Gentoo* have significantly higher carbon-13 values than *Adelie*. The interactions between nitrogen 15 and the species are significant, showing that the effect of nitrogen 15 on carbon 13 varies according to the species.

In conclusion, this model shows that the effect of nitrogen 15 on carbon 13 is highly species-dependent, with differences between species.

## Principal Component Analysis (PCA) of species characteristics {style="color:royalblue"}

```{r}
# Selection of quantitative data
data_numeric <- select_if(data, is.numeric)

# Remove sample_number 
# The body_mass et the flipper_length are more than 80% correlated, we're deleting flipper_length because it's the data that's most correlated with all the other data.
# names(data_numeric)
data_numeric <- data_numeric %>% select(-c("sample_number","flipper_length"))

# Normalizing data
data_scales <- scale(data_numeric)

# PCA realization
acp_data= PCA(data_scales, graph = F)
summary(acp_data)
```

@fig-eig_value_plot is an histogram of the variance of the factorial axes with the percentage of inertia of each axis. Here, we keep 2 dimensions and 78.4% inertia.

```{r}
#| label: fig-eig_value_plot
#| fig-cap: Barplot of eigen values
#| code-fold: true
#| code-summary: "Show the code"
#Variance for each component
va_propre = fviz_eig(acp_data, main ="", choice = "variance",
         label_size =50, addlabels = T,
         barfill  = "grey",barcolor = "grey")+
   ylim(c(0,60))
va_propre
```

@fig-contribution_plot assess the absolut contribution of variables to each axis. We can see that three variables make a strong contribution to axis 1 (*delta_15_N*, *body_mass* and *culmen_depth*) and 2 to axis 2 (*culmen_depth* and *delta_13_C*).

```{r,warning=FALSE,message=FALSE, fig.height=2, fig.width=5, fig.align = "center"}
#| label: fig-contribution_plot
#| fig-cap: Barplots of absolut contributions of axe 1 and 2
#| code-fold: true
#| code-summary: "Show the code"

#Contribution of axis variables axis 1 and 2
c1 = fviz_contrib(acp_data,choice = "var",axes =1,
                  fill = "grey",color = "grey")+ labs(title = "Axe 1") #For axe 1
c2 = fviz_contrib(acp_data,choice = "var",axes =2,
                  fill = "grey",color = "grey")+ labs(title = "Axe 2") #For axe 2
grid.arrange(c1,c2, ncol = 2)
```

First graph (@fig-projection) show the result of PCA on axes 1 and 2. *A priori* clustering by the Species has been performed. *Gentoo* penguins have a greater mass and a longer culmen. *Adelie* are lighter and have a depth culmen. *Chinstrap* penguins are the lightest and have a long, depth culmen. *Adelie* and *Chinstrap* penguins both have a high concentration of carbon 13 and nitrogen 15.

```{r,warning=FALSE,message=FALSE, fig.height=7, fig.width=12, fig.align = "center"}
#| label: fig-projection
#| fig-cap: Projection of variables and individuals according to species
#| code-fold: true
#| code-summary: "Show the code"

#Projection of variables and individuals and differentiation according to species
bi_plot = fviz_pca_biplot(acp_data, label="var", 
                habillage=data$species, 
                addEllipses = T,
                ellipse.alpha = F, 
                ylim=c(-3,3.5), xlim = c(-3.5,3.5))+
  scale_color_manual(values = c("#B2DF8A","#FDBF6F","#CAB2D6"))+
  theme_minimal()+
  theme(legend.position = "bottom")
grid.arrange(bi_plot, va_propre, c1, c2,  #names of graphs
             ncol = 2, nrow = 3, #How many row and col
             widths = c(2.2,1), #Here, the first col will be bigger than the second
             layout_matrix = cbind(c(1,1,1), #On the first col only graph 1 for the 3 rows
                                   c(2,3,4))) #On the second col, the 3 other graphs
```

Second graph (@fig-projection-islands) show the result of PCA on axes 1 and 2. *A priori* clustering by the Island has been performed. We can see that *Gentoo* penguins live only on Biscoe Island, while *Chinstrap* penguins live mainly on Dream Island. *Adelie* penguins live on these two islands and also on Togersen Island.

The common habitats of *Chinstrap* and *Adelie* penguins seem to explain the presence of isotopes in these two species, as they must find a similar diet.

```{r}
#| label: fig-projection-islands
#| fig-cap: Projection of variables and individuals and dfferentiation according to the islands
#| code-fold: true
#| code-summary: "Show the code"
#Projection of variables and individuals and differentiation according to species 
bi_plot = fviz_pca_biplot(acp_data, label="var",  habillage=data$island,  addEllipses = T,  ellipse.alpha = F,   ylim=c(-3,3.5),xlim = c(-3.5,3.5))+  
  scale_color_manual(values = c("#B2DF8A","#FDBF6F","#CAB2D6"))+  
  theme_minimal()+  theme(legend.position = "bottom") 
grid.arrange(bi_plot, va_propre, c1, c2, #names of graphs  
             ncol = 2, nrow = 3, #How many row and col  
             widths = c(2.2,1), #Here, the first col will be bigger than the second  
             layout_matrix = cbind(c(1,1,1), #On the first col only graph 1 for the 3 rows  
                                   c(2,3,4))) #On the second col, the 3 other graphs
```

# Model selection and validation {style="color:navy"}

## Data preparation and variable selection {style="color:royalblue"}

```{r}
#selection of the interesting variables
dataLM<-data %>% 
  select(species,island,clutch_completion,culmen_length,culmen_depth,flipper_length,body_mass,sex,delta_15_N,delta_13_C)

#set the variable type (factors or numerics)
dataLM$species<-as.factor(dataLM$species)
dataLM$island<-as.factor(dataLM$island)
dataLM$clutch_completion<-as.factor(dataLM$clutch_completion)
dataLM$sex<-as.factor(dataLM$sex)
dataLM$flipper_length<-as.numeric(dataLM$flipper_length)
dataLM$body_mass<-as.numeric(dataLM$body_mass)

str(dataLM)

#check if there is missing values 
colSums(is.na(dataLM))

#delete individual with missing values
dataLM<-dataLM %>% 
  drop_na(culmen_length,culmen_depth,flipper_length,body_mass,sex,delta_15_N,delta_13_C)

summary(dataLM)

```

```{r cofactors, include=TRUE}
# Factor Sex
summary(dataLM$sex)
# Factor Island
summary(dataLM$island)
# Factor Species
summary(dataLM$species)
# Factor Clutch completion
summary(dataLM$clutch_completion)
```

We observe that the plan is non orthogonal.

Secondly, we explore the dynamics between body mass and the explanatory variable, to identify if there any potential trend.

```{r datagraph, include=TRUE, fig.height=15, fig.width=6}
par(mfrow=c(5,2))
# Culmen length
plot(dataLM$body_mass~dataLM$culmen_length,pch=16,col='dodgerblue3',xlab='culmen length',ylab='body mass')
# Culmen depth
plot(dataLM$body_mass~dataLM$culmen_depth,pch=16,col='dodgerblue3',xlab='culmen depth',ylab='body mass')
# Flipper length
plot(dataLM$body_mass~dataLM$flipper_length,pch=16,col='dodgerblue3',xlab='flipper length',ylab='body mass')
# delta 15 N
plot(dataLM$body_mass~dataLM$delta_15_N,pch=16,col='dodgerblue3',xlab='delta 15N',ylab='body mass')
# delta 13 C
plot(dataLM$body_mass~dataLM$delta_13_C,pch=16,col='dodgerblue3',xlab='delta 13C',ylab='body mass')
#Species
boxplot(dataLM$body_mass~dataLM$species, varwidth = TRUE, ylab = "body mass", xlab = "Species", col='darkgrey', main = "")
#Island
boxplot(dataLM$body_mass~dataLM$island, varwidth = TRUE, ylab = "body mass", xlab = "Island", col='brown', main = "")
#Clutch completion
boxplot(dataLM$body_mass~dataLM$clutch_completion, varwidth = TRUE, ylab = "body mass", xlab = "Clutch completion", col='brown', main = "")
#Sex
boxplot(dataLM$body_mass~dataLM$sex, varwidth = TRUE, ylab = "body mass", xlab = "Sex", col='brown', main = "")
```

The variables that seems to influence body mass are *culmen_length*, *flipper_length*, *delta_15_N*, *species* and *island*.

Finally we check if there is colinearity between some variable. Starting with the covariables.

We chose a threshold of 0.7, to ensure there is no colinearity detected between the covariables.

Then, between cofactors. In order to do so, we plot all the covariable as a function of all cofactors.

```{r colinearity cofactors,include=TRUE, fig.height=15, fig.width=12}
# Checking collinearity between cofactors and covariables
par(mfrow=c(5,4))
#Culmen length and species
boxplot(dataLM$culmen_length~dataLM$species, varwidth = TRUE, ylab = "Culmen length", xlab = "Species", col='grey', main = "")
#Culmen length and island
boxplot(dataLM$culmen_length~dataLM$island, varwidth = TRUE, ylab = "Culmen length", xlab = "Island", col='grey', main = "")
#Culmen length and sex
boxplot(dataLM$culmen_length~dataLM$sex, varwidth = TRUE, ylab = "Culmen length", xlab = "Sex", col='grey', main = "")
#Culmen length and clutch completion
boxplot(dataLM$culmen_length~dataLM$clutch_completion, varwidth = TRUE, ylab = "Culmen length", xlab = "Clutch completion", col='grey', main = "")

#Culmen depth and species
boxplot(dataLM$culmen_depth~dataLM$species, varwidth = TRUE, ylab = "Culmen depth", xlab = "Species", col='grey', main = "")
#Culmen depth and island
boxplot(dataLM$culmen_depth~dataLM$island, varwidth = TRUE, ylab = "Culmen depth", xlab = "Island", col='grey', main = "")
#Culmen depth and sex
boxplot(dataLM$culmen_depth~dataLM$sex, varwidth = TRUE, ylab = "Culmen depth", xlab = "Sex", col='grey', main = "")
#Culmen depth and clutch completion
boxplot(dataLM$culmen_depth~dataLM$clutch_completion, varwidth = TRUE, ylab = "Culmen depth", xlab = "Clutch completion", col='grey', main = "")

#Flipper length and species
boxplot(dataLM$flipper_length~dataLM$species, varwidth = TRUE, ylab = "Flipper length", xlab = "Species", col='grey', main = "")
#Flipper length and island
boxplot(dataLM$flipper_length~dataLM$island, varwidth = TRUE, ylab = "Flipper length", xlab = "Island", col='grey', main = "")
#Flipper length and sex
boxplot(dataLM$flipper_length~dataLM$sex, varwidth = TRUE, ylab = "Flipper length", xlab = "Sex", col='grey', main = "")
#Flipper length and clutch completion
boxplot(dataLM$flipper_length~dataLM$clutch_completion, varwidth = TRUE, ylab = "Flipper length", xlab = "Clutch completion", col='grey', main = "")

#delta 15N and species
boxplot(dataLM$delta_15_N~dataLM$species, varwidth = TRUE, ylab = "delta 15N", xlab = "Species", col='grey', main = "")
#delta 15N and island
boxplot(dataLM$delta_15_N~dataLM$island, varwidth = TRUE, ylab = "delta 15N", xlab = "Island", col='grey', main = "")
#delta 15N and sex
boxplot(dataLM$delta_15_N~dataLM$sex, varwidth = TRUE, ylab = "delta 15N", xlab = "Sex", col='grey', main = "")
#delta 15N and clutch completion
boxplot(dataLM$delta_15_N~dataLM$clutch_completion, varwidth = TRUE, ylab = "delta 15N", xlab = "Clutch completion", col='grey', main = "")

#delta 13C and species
boxplot(dataLM$delta_13_C~dataLM$species, varwidth = TRUE, ylab = "delta 13C", xlab = "Species", col='grey', main = "")
#delta 13C and island
boxplot(dataLM$delta_13_C~dataLM$island, varwidth = TRUE, ylab = "delta 13C", xlab = "Island", col='grey', main = "")
#delta 13C and sex
boxplot(dataLM$delta_13_C~dataLM$sex, varwidth = TRUE, ylab = "delta 13C", xlab = "Sex", col='grey', main = "")
#delta 13C and clutch completion
boxplot(dataLM$delta_13_C~dataLM$clutch_completion, varwidth = TRUE, ylab = "delta 13C", xlab = "Clutch completion", col='grey', main = "")

```

## Model selection {style="color:royalblue"}

We build the statistical model, including all explanatory variable at first.

```{r full model}
modlm<-lm(body_mass ~ species + island + clutch_completion + culmen_length + culmen_depth + flipper_length + sex + delta_15_N + delta_13_C,data=dataLM) #full model
```

Now we are going to select the best model "by hand"

```{r full model selection}
drop1(modlm,test="F") #test significativté des variables avec test fischer
```

We exclude the variable *island* of the model, because it is the non-significant variable with the highest p-value. Then, we create a new model (without the variable *island*) and test for significance.

```{r model2}
modlm2<-lm(body_mass ~ species + clutch_completion + culmen_length + 
    culmen_depth + flipper_length + sex + delta_15_N + delta_13_C, data=dataLM)
drop1(modlm2,test="F")
```

As previously, we exclude the variable *clutch_completion* of the model, because it is non-significant. We build a new model and test again for variables' significance.

```{r model3}
modlm3<-lm(body_mass ~ species + culmen_length + 
    culmen_depth + flipper_length + sex + delta_15_N + delta_13_C, data=dataLM)
drop1(modlm3,test="F")
```

All the variable in the model are significant, so we keep all of them in our final model. The best model is thus: *body_mass \~ species + culmen_length + culmen_depth + flipper_length + sex + delta_15_N + delta_13_C*

```{r}
summary(modlm3)
```

Finally, the model can be written as:

$$ Body\:Mass = 1467.1\:+\:(Species_{Adeliae} = 0 \:;\:Species_{Pygoscelis antarctica} = -245.1^{**}\:;\:Species_{Pygoscelis papua} = 882.1^{***})$$ $$ +\:17.1^{*NS*}. Culmen\:Length\:+\:61.6^{**}. Culmen\:Depth\:+\:17.8^{***}. Flipper\:Length $$ $$ + (Sex_{Female}= 0\:;\: Sex_{Male}=417.9^{***})\:-\:164.3^{***}. Delta\:15N\:+\:65.2^{*}. Delta\:13C)$$

We can also notice that the model explain 88% of the body mass variance.

## Model validation {style="color:royalblue"}

We need the validation of the model. As this is a linear model, we must check for independence of the variable, as well as the normality and homoscedasticity of the residuals.

Here, we assume an independence of variables as we don't have the details of the data collection.

We check the normality of residuals.

```{r ResidNorm, include=TRUE, fig.height=3, fig.width=6}
par(mfrow=c(1,2))
# Histogram
hist(modlm3$residuals,col='dodgerblue3',xlab="residuals",main="Check Normality")
# Quantile-Quantile plot
qqnorm(modlm3$residuals,pch=16,col='dodgerblue3',xlab='')
qqline(modlm3$residuals,col='red',lwd=2)
```

Residuals have a normal distribution.

We check the homoscedasticity of residuals.

```{r Residhomo, include=TRUE, fig.height=5, fig.width=5}
# residuals vs fitted
plot(residuals(modlm3)~fitted(modlm3)
      , col='dodgerblue3'
      , pch=16)
abline(h = 0)

```

The variance is homogeneous.

We also verify that there is not individual that is particularly influential.

```{r Contri, include=TRUE, fig.height=4, fig.width=4}

par(mfrow = c(1, 1))
plot(cooks.distance(modlm3), type = "h", ylim = c(0, 1))
abline(h = 1, col = 2,lwd = 3)

```

As all the bar are lower that 1, there is no influential individuals.

We can conclude that the linear model is valid.
