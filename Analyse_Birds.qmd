---

title: "Modèles matriciels et applications"
group: "Rudy, Tanguy, Manon, Garan, Anaëlle, Oceane, Victor" 

bibliography: references.bib
execute: 
  freeze: auto
output: 
  html_document:
   toc: true
   toc_float: true
---



# Data presentation

The dataset (available following this link  https://zenodo.org/records/8251495 ) used for this work contains nest records from different studies conducted in North America and more specifically in Wisconsin and Illinois. It was conducted in 13 different counties : Dane, Grant, Green, Iowa, Lafayette, Monroe, Rock, Lee, Ogle, Will, Grundy, Carroll, and Jo Daviess counties. The dataset contains the records of 3257 nests and for each of them different observations.

These observations are the following:

- ***State***: Illinois or Wisconsin
- ***County***: Dane (Wisconsin), Grant (Wisconsin), Green (Wisconsin), Iowa (Wisconsin), Lafayette (Wisconsin), Monroe (Wisconsin), Rock (Wisconsin), Lee (Illinois), Ogle (Illinois), Will (Illinois), Grundy (Illinois), Carroll (Illinois), and Jo Daviess (Illinois)
- ***Habitat***: Cool-season Grassland, Pasture, Prairie, Warm-season Grassland
- ***Species***: Bobolink, Dickcissel, Eastern Meadowlark, Grasshopper Sparrow, Henslow’s Sparrow, Savannah Sparrow, Vesper Sparrow, and Western Meadowlark
- ***Years***: from 1991 to 2011
- ***Nest Fate***
- ***Initiation Date***
- ***Number fledged***
- ***Nest End Date***



All theses observations are presented in a table with the following collums : 

- *Nest_ID* = unique nest identifier
- *State* = State in which nest was located (Illinois or Wisconsin)
- *County* = County in the state in which nest was located
- *Habitat* = Grassy habitat in which nest was located (pasture, cool-season grassland, warm-season grassland, or prairie)
- *Species* = English common name
- *Year* = Year nest was found
- *Nest_Fate* = Successly fledged at least one young (1) or Failed (0).
- *Initiation_Date* = Coded date when the first egg was laid. April 1 = 1; May 1 = 31; June 1 = 62; July 1 = 92; August 1 = 123; September 1 = 154
- *Number_Fledged* = For a successful nest, number of young in nest on nest end date; For a failed nest, Number_Fledged is 0
- *Nest_End_Date* = Coded date when the nest failed or was successful. April 1 = 1; May 1 = 31; June 1 = 62; July 1 = 92; August 1 = 123; September 1 = 154

# What kind of questions can we rise ?


```{r,include=FALSE}
# Datatset import under the name of "data"
data <- read.csv("Bird_dataset.csv", sep=";", header = TRUE)

# Selecting the data of interest (here our study is going to focus on the state of illinois)
data_Illinois <- subset(data, data$State == "Illinois")

# Converting explanatory variables (or covariates) into factor (they were intially character chain )
data_Illinois$County <- as.factor(data_Illinois$County)
data_Illinois$Habitat <- as.factor(data_Illinois$Habitat)
data_Illinois$Species <- as.factor(data_Illinois$Species)
data_Illinois$Year <- as.factor(data_Illinois$Year)

# checking for missing values
colSums(is.na(data_Illinois))
```



```{r, include=FALSE}
library(knitr)
opts_chunk$set(echo = FALSE, comment = "", cache = TRUE, fig.align = "center")
library(ggplot2) # graph package
library(tinytex) # Pour la sortie pdf
library(corrplot)# Correlation matrix calculus
library(plot3D)# For 3D plot
library(DHARMa)# Model diagnosis
library(rcompanion)# Model pseudo R²
library(lattice)# Multipanel graphics
```




# Analysing the relationship between nest fate and county, habitat, species, year, initiation date using a generalized linear model (GLM) with a binomial distribution

## I. DATA EXPLORATION

Variables are :  

- *Nest_Fate* : Response variable 
- *County* : Covariate
- *Habitat* : Covariate
- *Species* : Covariate
- *Year* : Covariate
- *Initiation_Date* : Quantitative variable

**Aim of the study** : We want to model the faye of the nest as a response of the county, the habitat, the species, the year, the initiation date. We are looking for a model that could explain the dstribution of Nest fate. 

**Method** : Here our response variable is either a sucess or a failure. This response follows a binomial distribution with the probability density function $$P(X = k) = \binom{n}{k} p^k (1-p)^{n-k}$$

The term $$ \binom{n}{k} $$ is the binomial coefficient, which represents the number of ways to choose \( k \) successes from \( n \) trials. 

$$ p $$ is the probability of success on a single trial. 

$$1 - p$$ is the probability of failure on a single trial.

Every statistical analysis starts with the exploration of the dataset. 

### Outlier in $Y$ 

Here we are checking the values of Y (the values of Nest Fate)
```{r dataY, echo = FALSE}
# Number of 0 and 1 in Y
table(data_Illinois$Nest_Fate)

```

### For quantitative Xs : outlier and distribution of $X$ values

Here we have one quantitative $X$ variable. We check its distribution and if there is any outlier value. 

```{r dataCov, echo = FALSE, include=TRUE, fig.height=3, fig.width=8}
par(mfrow=c(1,3))

# Length
# Cleveland plot
dotchart(data_Illinois$Initiation_Date,pch=16,col='dodgerblue3',xlab='Initiation Date')
# Histogram
hist(data_Illinois$Initiation_Date,col='dodgerblue3',xlab="Initiation Date",main="")
# Quantile-Quantile plot
qqnorm(data_Illinois$Initiation_Date,pch=16,col='dodgerblue3',xlab='')
qqline(data_Illinois$Initiation_Date,col='red',lwd=2)
```

We do no observe any outlier and it seems that the initiation date of the nesting period follows a normal distribution. 


### For each covariate $X$  : Modalities and number of individuals for each of them

We need to analyse the modalities and the number of individuals for each modality. 

```{r datafact, echo = FALSE}
# Factor County
summary(data_Illinois$County)

# Factor Habitat
summary(data_Illinois$Habitat)

# Factor Species
summary(data_Illinois$Species)

# Factor Year
summary(data_Illinois$Year)
```


### Relationships between Y and Xs ?

We can then analyse graphically if we might have relationships between $Y$ and $Xs$. 

```{r datagraph, echo = FALSE, fig.height=4, fig.width=10}
par(mfrow=c(1,3))

# Initiation_Date
plot(data_Illinois$Nest_Fate~data_Illinois$Initiation_Date,pch=16,col='dodgerblue3',xlab='Initiation_Date',ylab='Nest_Fate')


# Define the color palette
color <- c('dodgerblue3', 'darkred', 'forestgreen', 'gold', 
           'purple', 'orange', 'cyan', 'magenta', 
           'salmon', 'lightseagreen', 'plum', 
           'yellowgreen', 'sandybrown', 'steelblue')

# County
mosaicplot(data_Illinois$Nest_Fate ~ data_Illinois$County, 
           col = color, 
           main="Relationship Nest Fate & County")
# Habitat
mosaicplot(data_Illinois$Nest_Fate ~ data_Illinois$Habitat, 
           col = color[1:4],  
           main = "Relationship Nest Fate & Habitat")

# Species
mosaicplot(data_Illinois$Nest_Fate ~ data_Illinois$Species, 
           col = color[1:8],  
           main = "Relationship Nest Fate & Species")

# Year
mosaicplot(data_Illinois$Nest_Fate ~ data_Illinois$Year, 
           col = color[1:6],  
           main = "Relationship Nest Fate & Year")


```


### Analysing interaction between Xs


```{r, echo = FALSE}

# Interactions entre County et Habitat avec Nest_Fate

# Utilisation de la fonction plot pour créer un fond neutre
plot(data_Illinois$Nest_Fate~data_Illinois$Habitat, type='n', ylab="Nest Fate", xlab="Habitat")

# Ajout des points pour chaque County
points(data_Illinois$Nest_Fate[data_Illinois$County=="Carroll"]~data_Illinois$Habitat[data_Illinois$County=="Carroll"], pch=16, cex=1, col='dodgerblue3')
points(data_Illinois$Nest_Fate[data_Illinois$County=="Grundy"]~data_Illinois$Habitat[data_Illinois$County=="Grundy"], pch=17, cex=1, col='darkred')
points(data_Illinois$Nest_Fate[data_Illinois$County=="Lee/Ogle"]~data_Illinois$Habitat[data_Illinois$County=="Lee/Ogle"], pch=18, cex=1, col='forestgreen')
points(data_Illinois$Nest_Fate[data_Illinois$County=="Will"]~data_Illinois$Habitat[data_Illinois$County=="Will"], pch=19, cex=1, col='gold')


```


### Checking collinearity  between $Xs$

To avoid multicollinearity in modeling, we need to analyze how the explanatory variables  $X_s$ are related. It is important to check for collinearity  as if some variables are correlated they mesure the same thing and therefore keeping both of them might lead to bad prediction.

```{r datacolin, echo = FALSE, fig.height=4, fig.width=8}
#  Vérification de la colinéarité entre variables catégorielles
# Tableau de contingence entre County et Habitat
table(data_Illinois$County, data_Illinois$Habitat)


# Tableau de contingence entre Species et Year
table(data_Illinois$Species, data_Illinois$Year)


# Boxplots pour vérifier la relation entre Initiation_Date et les variables catégorielles
par(mfrow=c(2,2))

# Initiation_Date et County
boxplot(data_Illinois$Initiation_Date ~ data_Illinois$County, xlab="County", ylab="Initiation Date")

# Initiation_Date et Habitat
boxplot(data_Illinois$Initiation_Date ~ data_Illinois$Habitat, xlab="Habitat", ylab="Initiation Date")

# Initiation_Date et Species
boxplot(data_Illinois$Initiation_Date ~ data_Illinois$Species, xlab="Species", ylab="Initiation Date")

# Initiation_Date et Year
boxplot(data_Illinois$Initiation_Date ~ data_Illinois$Year, xlab="Year", ylab="Initiation Date")


```


## II. Statistical Analysis

### Model building up


   
Because our response variable is a binary variable that follows a binomial distribution we have a link fucntion : the logit. 

 
```{r fullmodel,echo = FALSE}
# Model formulation
mod1<-glm(Nest_Fate~ County
        + Habitat
        + Species
        + Year
        + Initiation_Date
        ,data=data_Illinois
        ,family=binomial(link="logit"))
# Then we check for significance
drop1(mod1,test="Chi")
```


````{r, echo = FALSE}
# Modèle sans Initiation_Date
mod2 <- glm(Nest_Fate ~ County 
            + Habitat 
            + Species 
            + Year, 
            data = data_Illinois, 
            family = binomial(link = "logit"))

# Vérification des résultats après suppression
drop1(mod2, test = "Chi")

````
```{r}
# Modèle sans Initiation_Date et sans county
mod3 <- glm(Nest_Fate ~ Habitat 
            + Species 
            + Year, 
            data = data_Illinois, 
            family = binomial(link = "logit"))

# Vérification des résultats après suppression
drop1(mod3, test = "Chi")
```
```{r}
# Modèle sans Initiation_Date, sans county et sans habitat
mod4 <- glm(Nest_Fate ~ Species 
            + Year, 
            data = data_Illinois, 
            family = binomial(link = "logit"))

# Vérification des résultats après suppression
drop1(mod4, test = "Chi")
```


### Analysing model coefficient 
```{r, echo = FALSE}
# Coefficients of the model
summary(mod4)

```



### Explanation provided by the model

On procède aux calculs de *pseudo R²*
```{r deviance, echo = FALSE}
# Estimate of deviance explained
(mod4$null.deviance-mod4$deviance)/mod4$null.deviance

# Some others estimates of deviance explained - package 'rcompanion'
nagelkerke(mod4)
```

5%

## III. Model validation


### Analysing residuals



```{r ResidNB, echo = FALSE, fig.height=8, fig.width=6}

resid<-residuals(mod4, type="pearson")

par(mfrow=c(3,2))
# Histogram
hist(resid,col='dodgerblue3',xlab="residuals",main="")
# Quantile-Quantile plot
qqnorm(resid,pch=16,col='dodgerblue3',xlab='')
qqline(resid,col='red',lwd=2)

# residuals vs fitted
plot(resid~fitted(mod4)
      , col='dodgerblue3'
      , pch=16)
abline(h = 0)


```


### Checking for influent individuals

```{r Contri, echo = FALSE, fig.height=4, fig.width=4}
par(mfrow = c(1, 1))
plot(cooks.distance(mod1), type = "h", ylim = c(0, 1))
abline(h = 1, col = 2,lwd = 3)
```
Conclure sur la présence d'individus influents.

### Prediction with different data


```{r Simul, echo = FALSE, fig.height=4, fig.width=4}

# We could do a simulation
N    <- nrow(data_Illinois)
Pi   <- fitted(mod4)
data_Illinois$Ysim <- rbinom(N, size = 1, Pi)
# Classification table
Z <- table(data_Illinois$Nest_Fate, data_Illinois$Ysim) / N
rownames(Z) <- c("Observed 0", "Observed 1")
colnames(Z) <- c("Predicted 0", "Predicted 1")
Z
#Correctly classified:
sum(diag(Z))

# And repeat this 1000 times, store the results and calculate an average classification table

Pi   <- fitted(mod4)
N    <- nrow(data_Illinois)					
NSim <- 1000                           
diagZ<- matrix(nrow = N, ncol = NSim)
for (i in 1:NSim) {
  Ysim <- rbinom(N, size = 1, Pi)
  Z<- table(data_Illinois$Nest_Fate, Ysim) / N
  diagZ[,i]<-sum(diag(Z))
  }
#Average rate of individuals well-classified by the model
boxplot(diagZ[2,], col='dodgerblue3',ylab='#Rate of nest fate well-classified')
mean(diagZ[2,])
```



